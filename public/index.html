<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Event Social</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="./base.css">
    <link rel="stylesheet" type="text/css" href="./style.css">
</head>

<body>
    
    <section id="nav" class="hide">
        <div class="content main-nav">
            <h1 class="nav-title">Event Social Creator</h1>

            <div class="options">
                <!-- <a href="/" target="_blank" class="option button button-secondary">
                   Analyze Other Event
                </a> -->
            </div>
        </div>
    </section>

    <section id="url-screen">
        <img src="./back.png" class="back">
        <div class="content">

            <h2 class="title">
               Transform Your Event into Viral Posts
            </h2>
            <p class="description text">
                Paste your event website URL and let AI create a complete Instagram marketing campaign.
            </p>

            <div class="input-card">
                <form id="event-url-form">
                  <input class="input" type="text" id="event-url-input" placeholder="www.your-event-website.com">

                  <button analyze-url-btn class="button button-glared">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon"><path d="M9.937 15.5A2 2 0 0 0 8.5 14.063l-6.135-1.582a.5.5 0 0 1 0-.962L8.5 9.936A2 2 0 0 0 9.937 8.5l1.582-6.135a.5.5 0 0 1 .963 0L14.063 8.5A2 2 0 0 0 15.5 9.937l6.135 1.581a.5.5 0 0 1 0 .964L15.5 14.063a2 2 0 0 0-1.437 1.437l-1.582 6.135a.5.5 0 0 1-.963 0z"></path><path d="M20 3v4"></path><path d="M22 5h-4"></path><path d="M4 17v2"></path><path d="M5 18H3"></path></svg>
                    <span>Analyze Event & Generate Posts</span>
                  </button>
                </form>
            </div>
        </div>
    </section>

    <section id="fetching-screen">
        <img src="./back.png" class="back">
        <div class="content">
            <div class="loading-card">
                <h2 class="title">
                   Event web is being analyzed...
                </h2>
                <div class="progress-bar">
                  <div class="progress-bar-inner"></div>
                </div>
            </div>
        </div>
    </section>
   
   <section id="post-editor" class="">
       
       <div class="content">
           <button class="close button button-secondary" close>X</button>
           <div class="wrapper">
               
           </div>
       </div>
   </section>

   <div class="section-wrapper">
        
        <div id="side-nav" class="hide">
            <div class="tab-buttons-holder">
                <button class="button selected" tab-btn="social-campaign">
                   Social Plan
                </button>
                <button class="button" tab-btn="my-events">
                   My Events
                </button>
            </div>
            <div class="tab selected social-plan-tab" tab="social-campaign">
              <div class="title-holder">
                 <h2 class="title">
                   Your Social Campaign:
                 </h2>
              </div>
              <div class="info-holder">
                 <a class="event-url link" event-url="" href="" target="_blank">Event Url</a>

                 <p class="text info">Days Until Event: <span days-until-event="">31</span></p>

                 <!-- <p class="text info">Event Date: <span event-date="">2025-10-27</span></p> -->
                 <form>
                   <p class="text info">Event Name: </p>
                   <input event-name type="text" class="input" value="">

                   <p class="text info">Event Date: </p>
                   <input event-date type="date" class="input" value="">


                   <button update-data class="button button-glared">
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon"><path d="M9.937 15.5A2 2 0 0 0 8.5 14.063l-6.135-1.582a.5.5 0 0 1 0-.962L8.5 9.936A2 2 0 0 0 9.937 8.5l1.582-6.135a.5.5 0 0 1 .963 0L14.063 8.5A2 2 0 0 0 15.5 9.937l6.135 1.581a.5.5 0 0 1 0 .964L15.5 14.063a2 2 0 0 0-1.437 1.437l-1.582 6.135a.5.5 0 0 1-.963 0z"></path><path d="M20 3v4"></path><path d="M22 5h-4"></path><path d="M4 17v2"></path><path d="M5 18H3"></path></svg>
                     <span>Update Data</span>
                   </button>

                 </form>
                 
              </div>
            </div>


            <div class="tab events-tab" tab="my-events">
                <div class="title-holder">
                  <h2 class="title">
                    All Events:
                  </h2>
                </div>
                <div class="info-holder" events-list>
                    
                </div>

                <button analyze-new-event class="button button-glared">
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon"><path d="M9.937 15.5A2 2 0 0 0 8.5 14.063l-6.135-1.582a.5.5 0 0 1 0-.962L8.5 9.936A2 2 0 0 0 9.937 8.5l1.582-6.135a.5.5 0 0 1 .963 0L14.063 8.5A2 2 0 0 0 15.5 9.937l6.135 1.581a.5.5 0 0 1 0 .964L15.5 14.063a2 2 0 0 0-1.437 1.437l-1.582 6.135a.5.5 0 0 1-.963 0z"></path><path d="M20 3v4"></path><path d="M22 5h-4"></path><path d="M4 17v2"></path><path d="M5 18H3"></path></svg>
                     <span>Analyze New Event</span>
                </button>
            </div>

            
        </div>

    <section id="posts-screen">
        <div class="content">
            <div class="top-bar">
                <div class="title-holder">
                   <h3 class="posts-content-title">
                     AI Generated Posts List (<span posts-generated="">8</span>): 
                   </h3>
                </div>
            </div>
            <div class="posts-content">
              <div class="posts-wrapper">
                
              </div>
            </div>
        </div>
    </section>
    

      

    
    </div>

</body>

</html>

<script>
    const EventSocialManager = {
        state: {
            currentEvent:{
              webData: null,
              eventData: null,
              posts: [],
              tempPosts: [],
              currentPost: null,
              url: null,
            },

            events:[],
        },

        elements: {}, 

        async init() {
            this.showScreen('url-screen');
            this.setElements();
            this.bindEvents();

            this.checkStorage();
        },

        setElements() {
            this.elements = {
                urlScreen: document.querySelector('#url-screen'),
                analyzeUrlForm: document.querySelector('#event-url-form'),
                urlInput: document.querySelector('#event-url-input'),
                analyzeUrlBtn: document.querySelector('[analyze-url-btn]'),

                fetchingScreen: document.querySelector('#fetching-screen'),
                
                postsHolder: document.querySelector('#posts-screen .posts-wrapper'),


                postsGeneratedEls: document.querySelectorAll('[posts-generated]'),
                eventDate: document.querySelector('[event-date]'),
                daysUntilEventEls: document.querySelectorAll('[days-until-event]'),
                eventName: document.querySelector('[event-name]'),
                eventUrlEls: document.querySelectorAll('[event-url]'),
                updateDataBtn: document.querySelector('[update-data]'),

                postEditorEl: document.querySelector('#post-editor'),
                postEditorClose: document.querySelector('#post-editor .close'),

                tabButtonsEls: document.querySelectorAll('[tab-btn]'),
                eventsListEl: document.querySelector('[events-list]'),

                newEventBtn: document.querySelector('[analyze-new-event]'),
            } 
        },

        bindEvents() {
            this.elements.analyzeUrlForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const url = this.elements.urlInput.value;
                if (url) {
                    this.fetchAllData(url);
                } else {
                    console.log('Please enter a valid URL.');
                }
            });
            

            this.elements.postsHolder.addEventListener('click', (e) => {
                const post = e.target.closest('[post-card]');
                if (post) {
                    let id = post.getAttribute('post-card');
                    this.openPost(id);
                }
            });
            this.elements.postEditorClose.addEventListener('click',()=>{
                this.elements.postEditorEl.classList.remove('open');
            });


            this.elements.updateDataBtn.addEventListener('click',(e)=>{
                e.preventDefault();
                this.updateEventData();
            });

            

            this.elements.tabButtonsEls.forEach(tabBtn=>{
               tabBtn.addEventListener('click',()=>{
                  this.openTab(tabBtn);
               });
            });


            this.elements.newEventBtn.addEventListener('click',()=>{
                 this.analyzeNewEvent();
            });
            
            // window.addEventListener('beforeunload', () => {
            //     navigator.sendBeacon('/api/end-session', new Blob());
            // });
        },


        async fetchApi(endpoint, options = {}) {
            try {
                options.credentials = 'include'; 

                const response = await fetch(endpoint, options);
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({
                        error: 'An unknown server error occurred.'
                    }));
                    throw new Error(errorData.error || `Server responded with status: ${response.status}`);
                }
                return response.json();
            } catch (error) {
                console.error(`Failed to fetch ${endpoint}:`, error);
                throw error;
            }
        },


        async fetchAllData(url) {
            this.showScreen('fetching-screen');
            this.state.currentEvent.url = url;
            console.log(`Fetching data for: ${url}`);

            this.setLoadingProgress(2);
        
            try {
                
                await this.getWebData();
                this.setLoadingProgress(4);

                await this.getEventData();
                this.setLoadingProgress(7);

                await this.getPosts();

                
                this.renderPosts();

                console.log('posts rendered');

                // Transition the UI to the results screen
                const screen = document.querySelector('#fetching-screen');
                screen.classList.add('end-loading');

                this.renderData();

                this.state.events.push({
                  uid: this.generateUniqueCode(),
                  eventData: this.state.currentEvent,
                });

                this.saveData('full_state_data', this.state);

                setTimeout(() => {
                    this.showScreen('posts-screen');
                }, 1000);
        
            } catch (error) {
                // --- Failure Path ---
                console.error("Data fetch failed:", error.message);
            }
        },


        async getWebData(){
            const response = await this.fetchApi('/api/analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ url: this.state.currentEvent.url, 
                                       request: 'web_data',
                                       webData: null })
            });
        
            console.log("Web Data received");
        
            // Update state with the new data
            this.state.currentEvent.webData = response;
        },
        async getEventData(){
            const response = await this.fetchApi('/api/analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ url: this.state.currentEvent.url, 
                                       request: 'event_data', 
                                       webData: this.state.currentEvent.webData })
            });
        
            console.log("Event Data received:", response);
        
            // Update state with the new data
            this.state.currentEvent.eventData = response;
        },
        async getPosts(){
            const response = await this.fetchApi('/api/analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ url: this.state.currentEvent.url, 
                                       request: 'posts', 
                                       webData: JSON.stringify(this.state.currentEvent.eventData) })
            });
        
            console.log("Posts received:", response);
        
            // Update state with the new data
            this.state.currentEvent.posts = response;
        },

        async getRemadePosts(){

            let newData = {
                eventData: this.state.eventData,
                posts: this.state.posts,
            }

            newData.posts.forEach(post=>{
                post.date = null;
            })

            const response = await this.fetchApi('/api/analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ url: this.state.currentEvent.url, 
                                       request: 'posts_remake', 
                                       webData: JSON.stringify(newData) })
            });
        
            console.log("Remake Posts received:", response);
        
            // Update state with the new data
            this.state.currentEvent.posts = response;
        },



        async updateEventData(){
           this.saveData('full_state_data',this.state);

           this.state.currentEvent.tempPosts.push(this.state.currentEvent.posts);


           
           this.state.currentEvent.eventData.eventName = this.elements.eventName.value;
           this.state.currentEvent.eventData.eventDate = this.elements.eventDate.value;
           
           this.showScreen('fetching-screen');
           const screen = document.querySelector('#fetching-screen');
           screen.classList.remove('end-loading');

           this.setLoadingProgress(2);
        
           try {
                await this.getPosts();
                this.setLoadingProgress(3);

                setTimeout(() => {
                   this.setLoadingProgress(5); 
                });
                
                this.renderPosts();

                console.log('posts rendered');

                // Transition the UI to the results screen
                const screen = document.querySelector('#fetching-screen');
                screen.classList.add('end-loading');

                this.renderData();

                setTimeout(() => {
                    this.showScreen('posts-screen');
                }, 1000);
        
            } catch (error) {
                // --- Failure Path ---
                console.error("Data fetch failed:", error.message);

                // Transition the UI to the results screen
                const screen = document.querySelector('#fetching-screen');
                screen.classList.add('end-loading');

                this.renderData();

                setTimeout(() => {
                    this.showScreen('posts-screen');
                }, 1000);
            }
        },



        analyzeNewEvent(){
            this.showScreen('url-screen');
            const screen = document.querySelector('#fetching-screen');
            screen.classList.remove('end-loading');

            this.openTab(document.querySelector('[tab-btn="social-campaign"]'));
        },


        // --- UI RENDERING ---
        showScreen(screenName) { 
            let screens = document.querySelectorAll('section');
            screens.forEach(screen=>{
              screen.classList.add('hide');
            });

            let screen = document.querySelector(`#${screenName}`);
            screen.classList.remove('hide');

            if(screenName == 'fetching-screen'){
                screen.classList.add('loading');
            }

            if(screenName == 'posts-screen'){
                 document.querySelector('#nav').classList.remove('hide');
                 document.querySelector('#side-nav').classList.remove('hide');
            }
        },

        openPost(id){
           let post = document.querySelector(`[post-card="${id}"]`);
           this.elements.postEditorEl.classList.add('open');
           let inner = this.elements.postEditorEl.querySelector('.wrapper');
           inner.innerHTML = post.innerHTML;
        },



        setLoadingProgress(val){
           this.elements.fetchingScreen.setAttribute('progress',val);
        },


        renderPosts(){
            let html = ``;

            this.elements.postsHolder.innerHTML = html;

            this.state.currentEvent.posts.forEach((post,key)=>{
                html += `
                    <div class="post-card" post-card="${key}">
                        <div class="img-holder">
                           
                        </div>
                        <div class="bar">
                            <p class="type" type="${post.type}">${post.type.replace('_',' ')}</p>
                            <p class="date">posting date: <span>${post.date}</span></p>
                        </div>
                        <h3 class="post-title">${post.title}</h3>
                        <p class="post-content">${post.content}</p>
                        <div class="hashtags">
                            ${post.hashtags.map(hashtag => {
                                return `<p class="hashtag">${hashtag}</p>`;
                            }).join('')} 
                        </div>
                    </div>
                `;
            });

            this.elements.postsHolder.innerHTML = html;
        },

        renderData(){
            this.elements.postsGeneratedEls.forEach(el=>{
               el.innerHTML = this.state.currentEvent.posts.length;
            });

            this.elements.eventDate.value = this.state.currentEvent.eventData.eventDate;
            
            this.elements.eventName.value = this.state.currentEvent.eventData.eventName;


            this.elements.daysUntilEventEls.forEach(el=>{
               el.innerHTML = this.getDaysUntil(this.state.currentEvent.eventData.eventDate);
            });

            

            this.elements.eventUrlEls.forEach(el=>{
               el.href = this.state.currentEvent.url;
            });
        },

        getDaysUntil(futureDateStr) {
         // Get today's date and set the time to the beginning of the day
         const today = new Date();
         today.setHours(0, 0, 0, 0);
       
         // Create a Date object for the future date
         const futureDate = new Date(futureDateStr);
       
         // Calculate the difference in milliseconds
         const timeDifference = futureDate.getTime() - today.getTime();
       
         // Convert milliseconds to days and round up
         const daysRemaining = Math.ceil(timeDifference / (1000 * 60 * 60 * 24));
       
         return daysRemaining;
        },
    
        

        renderEvents(){
            let events = '';
            this.state.events.forEach(event=>{
                 events += `
                    <p class="event-item" 
                       event="${event.uid}" >
                         ${event.eventData.eventData.eventName}
                    </p>
                 `;
            });
            this.elements.eventsListEl.innerHTML = events;
        },
 
        openTab(tabBtn){
           document.querySelectorAll('[tab],[tab-btn]').forEach(tab=>{
               tab.classList.remove('selected');
           })
           let tab = document.querySelector(`[tab="${tabBtn.getAttribute('tab-btn')}"]`);
           tabBtn.classList.add('selected');
           tab.classList.add('selected');
        },


        // saving and loading
        checkStorage(){
           let data = this.loadData('full_state_data');
           if(data == null){
             return;
           }
           
           this.state = data;

           this.showScreen("posts-screen");
           this.renderPosts();
           this.renderData();
           this.renderEvents();
        },
        saveData(key, data) {
            try {
                // Convert the JavaScript object into a JSON string before saving.
                const serializedData = JSON.stringify(data);
                localStorage.setItem(key, serializedData);
                console.log(`Data saved successfully for key: ${key}`);
            } catch (error) {
                console.error("Error saving data to localStorage:", error);
            }
        },
        loadData(key) {
            try {
                const serializedData = localStorage.getItem(key);
                
                // Return null if no data is found for the key.
                if (serializedData === null) {
                    console.log(`No data found for key: ${key}`);
                    return null;
                }
                
                // Convert the JSON string back into a JavaScript object.
                return JSON.parse(serializedData);
            } catch (error) {
                console.error("Error retrieving or parsing data from localStorage:", error);
                return null;
            }
        },



        // misc
        generateUniqueCode() {
          // 1. Get the current Unix timestamp in milliseconds.
          const timestamp = Date.now();
          
          // 2. Convert the timestamp to a Base36 string (shorter, alphanumeric representation).
          const timeBase36 = timestamp.toString(36);
          
          // 3. Generate a small random component (using a character from a random Base36 string)
          // to ensure uniqueness when the function is executed in rapid succession.
          const randomComponent = Math.random().toString(36).substring(2, 3);
          
          // Combine time and a small random factor.
          return timeBase36 + randomComponent;
        },

    };

    document.addEventListener('DOMContentLoaded', () => {
        EventSocialManager.init();
    });
</script>



