<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Event Social</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="./base.css">
    <link rel="stylesheet" type="text/css" href="./style.css">
</head>

<body>
    

    <section id="url-screen">
        <img src="./back.jpg" class="back">
        <div class="content">
            <div class="input-card">
                <h2 class="title">
                   Transform Your Event into Viral Posts
                </h2>
                <p class="description text">
                    Paste your event website URL and let AI create a complete Instagram marketing campaign
                </p>
                
                <form id="event-url-form">
                  <input class="input" type="text" id="event-url-input" placeholder="www.your-event-website.com">

                  <button analyze-url-btn class="button">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon"><path d="M9.937 15.5A2 2 0 0 0 8.5 14.063l-6.135-1.582a.5.5 0 0 1 0-.962L8.5 9.936A2 2 0 0 0 9.937 8.5l1.582-6.135a.5.5 0 0 1 .963 0L14.063 8.5A2 2 0 0 0 15.5 9.937l6.135 1.581a.5.5 0 0 1 0 .964L15.5 14.063a2 2 0 0 0-1.437 1.437l-1.582 6.135a.5.5 0 0 1-.963 0z"></path><path d="M20 3v4"></path><path d="M22 5h-4"></path><path d="M4 17v2"></path><path d="M5 18H3"></path></svg>
                    <span>Analyze Event & Generate Posts</span>
                  </button>
                </form>
            </div>
        </div>
    </section>

    <section id="fetching-screen">
        <img src="./back.jpg" class="back">
        <div class="content">
            <div class="loading-card">
                <h2 class="title">
                   Event web is being analyzed
                </h2>

                <div class="progress-bar">
                  <div class="progress-bar-inner"></div>
                </div>
            </div>
        </div>
    </section>

    <section id="posts-screen">
        <div class="content">
            <h2 class="title">
                Your Instagram Campaign
            </h2>
            <p class="text">
                AI generated strategic posts for your event promotion
            </p>
            <div class="posts-wrapper">
                
            </div>
        </div>
    </section>
    

</body>

</html>

<script>
    const EventSocialManager = {
        state: {
            webData: null,
            eventData: null,
            posts: [],
            currentPost: null,
            url: null,
        },

        elements: {}, 

        async init() {
            this.showScreen('url-screen');
            this.setElements();
            this.bindEvents();
        },

        setElements() {
            this.elements = {
                urlScreen: document.querySelector('#url-screen'),
                analyzeUrlForm: document.querySelector('#event-url-form'),
                urlInput: document.querySelector('#event-url-input'),
                analyzeUrlBtn: document.querySelector('[analyze-url-btn]'),
                
                postsHolder: document.querySelector('#posts-screen .posts-wrapper'),
            } 
        },

        bindEvents() {
            this.elements.analyzeUrlForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const url = this.elements.urlInput.value;
                if (url) {
                    this.fetchAllData(url);
                } else {
                    console.log('Please enter a valid URL.');
                }
            });
            
            

            // this.elements.analysisTabsContainer.addEventListener('click', (e) => {
            //     const button = e.target.closest('button');
            //     if (button && button.dataset.analysisType) {
            //         this.state.activeAnalysisType = button.dataset.analysisType;
            //         this.render();
            //     }
            // });


            
            // window.addEventListener('beforeunload', () => {
            //     navigator.sendBeacon('/api/end-session', new Blob());
            // });
        },


        async fetchApi(endpoint, options = {}) {
            try {
                options.credentials = 'include'; 

                const response = await fetch(endpoint, options);
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({
                        error: 'An unknown server error occurred.'
                    }));
                    throw new Error(errorData.error || `Server responded with status: ${response.status}`);
                }
                return response.json();
            } catch (error) {
                console.error(`Failed to fetch ${endpoint}:`, error);
                throw error;
            }
        },

        // Step 1 of the analysis process
        async fetchAllData(url) {
            this.showScreen('fetching-screen');
            this.state.url = url;
            console.log(`Fetching data for: ${url}`);
        
            try {
                // --- Success Path ---
                const response = await this.fetchApi('/api/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url: this.state.url })
                });
        
                console.log("Data received:", response);
        
                // Update state with the new data
                this.state.webData = response.webData;
                this.state.posts = response.posts;
                
                this.renderPosts();


                // Transition the UI to the results screen
                const screen = document.querySelector('#fetching-screen');
                screen.classList.add('end-loading');

                setTimeout(() => {
                    this.showScreen('posts-screen');
                }, 1000);
        
            } catch (error) {
                // --- Failure Path ---
                console.error("Data fetch failed:", error.message);
            }
        },


        async fetchAllData(url) {
            this.showScreen('fetching-screen');
            this.state.url = url;
            console.log(`Fetching data for: ${url}`);
        
            try {
                
                await getWebData();
                await getEventData();
                await getPosts();

                
                this.renderPosts();

                // Transition the UI to the results screen
                const screen = document.querySelector('#fetching-screen');
                screen.classList.add('end-loading');

                setTimeout(() => {
                    this.showScreen('posts-screen');
                }, 1000);
        
            } catch (error) {
                // --- Failure Path ---
                console.error("Data fetch failed:", error.message);
            }
        },


        async getWebData(){
            const response = await this.fetchApi('/api/analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ url: this.state.url, 
                                       request: 'web_data',
                                       webData: null })
            });
        
            console.log("Web Data received:", response);
        
            // Update state with the new data
            this.state.webData = response;
        }
        async getEventData(){
            const response = await this.fetchApi('/api/analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ url: this.state.url, 
                                       request: 'event_data', 
                                       webData: this.state.webData })
            });
        
            console.log("Event Data received:", response);
        
            // Update state with the new data
            this.state.eventData = response;
        }
        async getPosts(){
            const response = await this.fetchApi('/api/analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ url: this.state.url, 
                                       request: 'posts', 
                                       webData: JSON.stringify(this.state.eventData) })
            });
        
            console.log("Posts received:", response);
        
            // Update state with the new data
            this.state.posts = response;
        }


        // --- UI RENDERING ---
        showScreen(screenName) { 
            let screens = document.querySelectorAll('section');
            screens.forEach(screen=>{
              screen.classList.add('hide');
            });

            let screen = document.querySelector(`#${screenName}`);
            screen.classList.remove('hide');

            if(screenName == 'fetching-screen'){
                screen.classList.add('loading');
            }
        },


        renderPosts(){
            let html = ``;

            this.state.posts.forEach(post=>{
                html += `
                    <div class="post-card">
                       <div class="bar">
                           <p class="type">${post.type}</p>
                           <p class="date">posting date: ${post.date}</p>
                       </div>
                       <h3 class="post-title">${post.title}</h3>
                       <p class="post-content">${post.content}</p>
                    </div>
                `;
            });

            this.elements.postsHolder.innerHTML = html;
        }
    };

    document.addEventListener('DOMContentLoaded', () => {
        EventSocialManager.init();
    });
</script>



