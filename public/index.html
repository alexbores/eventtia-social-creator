<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Event Social</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="./base.css">
    <link rel="stylesheet" type="text/css" href="./style.css">
</head>

<body>
    
    <section id="nav">
        <div class="content main-nav">
            <h1 class="nav-title">Event Social Creator</h1>

            <div class="options">
                <a href="/" target="_blank" class="option button button-secondary">
                   Analyze Other Event
                </a>
            </div>
        </div>
    </section>

    <section id="url-screen">
        <img src="./back.png" class="back">
        <div class="content">

            <h2 class="title">
               Transform Your Event into Viral Posts
            </h2>
            <p class="description text">
                Paste your event website URL and let AI create a complete Instagram marketing campaign.
            </p>

            <div class="input-card">
                <form id="event-url-form">
                  <input class="input" type="text" id="event-url-input" placeholder="www.your-event-website.com">

                  <button analyze-url-btn class="button button-glared">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon"><path d="M9.937 15.5A2 2 0 0 0 8.5 14.063l-6.135-1.582a.5.5 0 0 1 0-.962L8.5 9.936A2 2 0 0 0 9.937 8.5l1.582-6.135a.5.5 0 0 1 .963 0L14.063 8.5A2 2 0 0 0 15.5 9.937l6.135 1.581a.5.5 0 0 1 0 .964L15.5 14.063a2 2 0 0 0-1.437 1.437l-1.582 6.135a.5.5 0 0 1-.963 0z"></path><path d="M20 3v4"></path><path d="M22 5h-4"></path><path d="M4 17v2"></path><path d="M5 18H3"></path></svg>
                    <span>Analyze Event & Generate Posts</span>
                  </button>
                </form>
            </div>
        </div>
    </section>

    <section id="fetching-screen">
        <img src="./back.png" class="back">
        <div class="content">
            <div class="loading-card">
                <h2 class="title">
                   Event web is being analyzed...
                </h2>
                <div class="progress-bar">
                  <div class="progress-bar-inner"></div>
                </div>
            </div>
        </div>
    </section>
   
   <section id="post-editor" class="">
       
       <div class="content">
           <button class="close button button-secondary" close>X</button>
           <div class="wrapper">
               
           </div>
       </div>
   </section>

   <div class="section-wrapper">
        
        <div id="side-nav">
            <div class="title-holder">
               <h2 class="title">
                 Your Social Campaign
               </h2>
            </div>
            <div class="info-holder">
               <p class="text info">Days Until Event: <span days-until-event="">31</span></p>

               <!-- <p class="text info">Event Date: <span event-date="">2025-10-27</span></p> -->
               <form>
                 <p class="text info">Event Date: </p>
                 <input event-date type="date" class="input" value="2025-10-27">
                 <button analyze-url-btn class="button button-secondary">
                   Update Date
                 </button>
               </form>
               
            </div>


            <form class="analyze-again-form">
              <button analyze-again class="button button-glared">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon"><path d="M9.937 15.5A2 2 0 0 0 8.5 14.063l-6.135-1.582a.5.5 0 0 1 0-.962L8.5 9.936A2 2 0 0 0 9.937 8.5l1.582-6.135a.5.5 0 0 1 .963 0L14.063 8.5A2 2 0 0 0 15.5 9.937l6.135 1.581a.5.5 0 0 1 0 .964L15.5 14.063a2 2 0 0 0-1.437 1.437l-1.582 6.135a.5.5 0 0 1-.963 0z"></path><path d="M20 3v4"></path><path d="M22 5h-4"></path><path d="M4 17v2"></path><path d="M5 18H3"></path></svg>
                <span>Analyze Again</span>
              </button>
            </form>
        </div>

    <section id="posts-screen">
        <div class="content">
            <div class="top-bar">
                <div class="title-holder">
                  <h2 class="title">
                    Your Instagram Campaign
                  </h2>
                  <p class="text">
                    AI generated strategic posts for your event promotion
                  </p>
                </div>
                <div class="info-holder">
                    <p class="text info">Posts Generated: <span posts-generated></span></p>
                    <p class="text info">Event Date: <span event-date></span></p>
                    <p class="text info">Days Until Event: <span days-until-event></span></p>
                </div>
            </div>
            <div class="posts-content">
              <h3 class="posts-content-title">
                  Posts List:
              </h3>
              <div class="posts-wrapper">
                
              </div>
            </div>
        </div>
    </section>
    

      

     <!--  <section id="posts-screen" class="">
        <div class="content">
            <div class="top-bar">
                <div class="title-holder">
                   <h3 class="posts-content-title">
                     AI Generated Posts List (<span posts-generated="">8</span>): 
                   </h3>
                </div>
            </div>
            <div class="posts-content">
              
              <div class="posts-wrapper">
                    <div class="post-card" post-card="1">
                        <div class="bar">
                            <p class="type" type="announcement">announcement</p>
                            <p class="date">posting date: <span>2025-09-28</span></p>
                            
                        </div>
                        <h3 class="post-title">üé® Join 'An Evening with Paintvine'</h3>
                        <p class="post-content">Get ready for a night blending art and fine wine! Join Liv Carter &amp; The Mumm RSRV Club on October 27th at The Boat Shed ≈årakei, Auckland. Enjoy an interactive evening showcasing artistic flair. RSVP now and secure your spot at https://live.eventtia.com/en/soulrsrv.</p>
                        <div class="hashtags">
                            <p class="hashtag">#Paintvine2025</p><p class="hashtag">#AucklandEvenings</p><p class="hashtag">#ArtAndWine</p> 
                        </div>
                    </div>
                
                    <div class="post-card">
                        <div class="bar">
                            <p class="type" type="venue">venue</p>
                            <p class="date">posting date: <span>2025-10-05</span></p>
                            
                        </div>
                        <h3 class="post-title">üìç Venue Spotlight: The Boat Shed ≈årakei</h3>
                        <p class="post-content">Discover the venue for our upcoming event: The Boat Shed ≈årakei in Auckland. With its stunning backdrop, it's the perfect setting for 'An Evening with Paintvine'. Don't miss it! RSVP now at https://live.eventtia.com/en/soulrsrv.</p>
                        <div class="hashtags">
                            <p class="hashtag">#BoatShedOrakei</p><p class="hashtag">#AucklandEvents</p><p class="hashtag">#EventVenues</p> 
                        </div>
                    </div>
                
                    <div class="post-card">
                        <div class="bar">
                            <p class="type" type="activity">activity</p>
                            <p class="date">posting date: <span>2025-10-09</span></p>
                            
                        </div>
                        <h3 class="post-title">üçá New Vintage Blanc de Noirs 2012</h3>
                        <p class="post-content">Excited to taste something unique at our event? Discover aromas of apricots and toasted brioche with the New Vintage RSRV Blanc de Noirs 2012, aged for six years. Limited allocation available for attendees. RSVP today!</p>
                        <div class="hashtags">
                            <p class="hashtag">#BlancDeNoirs2012</p><p class="hashtag">#WineLovers</p><p class="hashtag">#RSRVClub</p> 
                        </div>
                    </div>
                
                    <div class="post-card">
                        <div class="bar">
                            <p class="type" type="urgency">urgency</p>
                            <p class="date">posting date: <span>2025-10-14</span></p>
                            
                        </div>
                        <h3 class="post-title">‚è≥ Countdown: 2 Weeks to Go!</h3>
                        <p class="post-content">Just two weeks left until 'An Evening with Paintvine'! Secure your spot for an artistic night filled with creativity and flavors. RSVP at https://live.eventtia.com/en/soulrsrv before it's too late!</p>
                        <div class="hashtags">
                            <p class="hashtag">#PaintvineCountdown</p><p class="hashtag">#RSVPNow</p><p class="hashtag">#ArtEvent</p> 
                        </div>
                    </div>
                
                    <div class="post-card">
                        <div class="bar">
                            <p class="type" type="announcement">announcement</p>
                            <p class="date">posting date: <span>2025-10-21</span></p>
                            
                        </div>
                        <h3 class="post-title">üéÅ Birthday Treats Await!</h3>
                        <p class="post-content">Are you part of the RSRV Club? Update your details before the event and enjoy exclusive birthday treats at 'An Evening with Paintvine'. Join us at https://live.eventtia.com/en/soulrsrv for a memorable night.</p>
                        <div class="hashtags">
                            <p class="hashtag">#RSRVClubPerks</p><p class="hashtag">#BirthdaySurprise</p><p class="hashtag">#JoinUs</p> 
                        </div>
                    </div>
                
                    <div class="post-card">
                        <div class="bar">
                            <p class="type" type="urgency">urgency</p>
                            <p class="date">posting date: 2025-10-24</p>
                            
                        </div>
                        <h3 class="post-title">üóìÔ∏è This Weekend: 'An Evening with Paintvine'</h3>
                        <p class="post-content">Only a few days left! Join us this weekend for 'An Evening with Paintvine' at The Boat Shed ≈årakei. Confirm your attendance now and don't miss this artistic experience! RSVP at https://live.eventtia.com/en/soulrsrv.</p>
                        <div class="hashtags">
                            <p class="hashtag">#WeekendPlans</p><p class="hashtag">#ArtAndWine</p><p class="hashtag">#LastChance</p> 
                        </div>
                    </div>
                
                    <div class="post-card">
                        <div class="bar">
                            <p class="type" type="reminder">reminder</p>
                            <p class="date">posting date: 2025-10-26</p>
                            
                        </div>
                        <h3 class="post-title">üì¢ Important Reminder for Tomorrow!</h3>
                        <p class="post-content">Just one day to go until 'An Evening with Paintvine'! Ensure you're all set for a night of art and wine at The Boat Shed ≈årakei. All details and last-minute RSVPs at https://live.eventtia.com/en/soulrsrv.</p>
                        <div class="hashtags">
                            <p class="hashtag">#EventReminder</p><p class="hashtag">#AucklandArt</p><p class="hashtag">#RSRVClub</p> 
                        </div>
                    </div>
                
                    <div class="post-card">
                        <div class="bar">
                            <p class="type" type="event_day">event day</p>
                            <p class="date">posting date: 2025-10-27</p>
                            
                        </div>
                        <h3 class="post-title">üéä It's Today: 'An Evening with Paintvine'!</h3>
                        <p class="post-content">The wait is over! 'An Evening with Paintvine' kicks off today at 4 PM at The Boat Shed ≈årakei. Showcasing artistic flair with the best RSRV wines. Don't miss your chance to be part of this unique event.</p>
                        <div class="hashtags">
                            <p class="hashtag">#EventDay</p><p class="hashtag">#ArtAndWine</p><p class="hashtag">#AucklandEvents</p> 
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section> -->
    
    </div>

</body>

</html>

<script>
    const EventSocialManager = {
        state: {
            webData: null,
            eventData: null,
            posts: [],
            currentPost: null,
            url: null,
        },

        elements: {}, 

        async init() {
            this.showScreen('url-screen');
            this.setElements();
            this.bindEvents();
        },

        setElements() {
            this.elements = {
                urlScreen: document.querySelector('#url-screen'),
                analyzeUrlForm: document.querySelector('#event-url-form'),
                urlInput: document.querySelector('#event-url-input'),
                analyzeUrlBtn: document.querySelector('[analyze-url-btn]'),

                fetchingScreen: document.querySelector('#fetching-screen'),
                
                postsHolder: document.querySelector('#posts-screen .posts-wrapper'),


                postsGeneratedEls: document.querySelectorAll('[posts-generated]'),
                eventDateEls: document.querySelectorAll('[event-date]'),
                daysUntilEventEls: document.querySelectorAll('[days-until-event]'),

                postEditorEl: document.querySelector('#post-editor'),
                postEditorClose: document.querySelector('#post-editor .close'),
            } 
        },

        bindEvents() {
            this.elements.analyzeUrlForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const url = this.elements.urlInput.value;
                if (url) {
                    this.fetchAllData(url);
                } else {
                    console.log('Please enter a valid URL.');
                }
            });
            

            this.elements.postsHolder.addEventListener('click', (e) => {
                const post = e.target.closest('[post-card]');
                if (post) {
                    let id = post.getAttribute('post-card');
                    this.openPost(id);
                }
            });
            this.elements.postEditorClose.addEventListener('click',()=>{
                this.elements.postEditorEl.classList.remove('open');
            });


            
            // window.addEventListener('beforeunload', () => {
            //     navigator.sendBeacon('/api/end-session', new Blob());
            // });
        },


        async fetchApi(endpoint, options = {}) {
            try {
                options.credentials = 'include'; 

                const response = await fetch(endpoint, options);
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({
                        error: 'An unknown server error occurred.'
                    }));
                    throw new Error(errorData.error || `Server responded with status: ${response.status}`);
                }
                return response.json();
            } catch (error) {
                console.error(`Failed to fetch ${endpoint}:`, error);
                throw error;
            }
        },


        async fetchAllData(url) {
            this.showScreen('fetching-screen');
            this.state.url = url;
            console.log(`Fetching data for: ${url}`);

            this.setLoadingProgress(2);
        
            try {
                
                await this.getWebData();
                this.setLoadingProgress(4);

                await this.getEventData();
                this.setLoadingProgress(7);

                await this.getPosts();

                
                this.renderPosts();

                // Transition the UI to the results screen
                const screen = document.querySelector('#fetching-screen');
                screen.classList.add('end-loading');

                this.renderData();

                setTimeout(() => {
                    this.showScreen('posts-screen');
                }, 1000);
        
            } catch (error) {
                // --- Failure Path ---
                console.error("Data fetch failed:", error.message);
            }
        },


        async getWebData(){
            const response = await this.fetchApi('/api/analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ url: this.state.url, 
                                       request: 'web_data',
                                       webData: null })
            });
        
            console.log("Web Data received");
        
            // Update state with the new data
            this.state.webData = response;
        },
        async getEventData(){
            const response = await this.fetchApi('/api/analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ url: this.state.url, 
                                       request: 'event_data', 
                                       webData: this.state.webData })
            });
        
            console.log("Event Data received:", response);
        
            // Update state with the new data
            this.state.eventData = response;
        },
        async getPosts(){
            const response = await this.fetchApi('/api/analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ url: this.state.url, 
                                       request: 'posts', 
                                       webData: JSON.stringify(this.state.eventData) })
            });
        
            console.log("Posts received:", response);
        
            // Update state with the new data
            this.state.posts = response;
        },


        // --- UI RENDERING ---
        showScreen(screenName) { 
            let screens = document.querySelectorAll('section');
            screens.forEach(screen=>{
              screen.classList.add('hide');
            });

            let screen = document.querySelector(`#${screenName}`);
            screen.classList.remove('hide');

            if(screenName == 'fetching-screen'){
                screen.classList.add('loading');
            }
        },

        openPost(id){
           let post = document.querySelector(`[post-card="${id}"]`);
           this.elements.postEditorEl.classList.add('open');
           let inner = this.elements.postEditorEl.querySelector('.wrapper');
           inner.innerHTML = post.innerHTML;
        },



        setLoadingProgress(val){
           this.elements.fetchingScreen.setAttribute('progress',val);
        },


        renderPosts(){
            let html = ``;

            this.elements.postsHolder.innerHTML = html;

            this.state.posts.forEach((key,post)=>{
                // let daysUntilEvent = getDaysUntil(post.date);
                html += `
                    <div class="post-card" post-card="${key}">
                        <div class="bar">
                            <p class="type" type="${post.type}">${post.type.replace('_',' ')}</p>
                            <p class="date">posting date: <span>${post.date}</span></p>
                            
                        </div>
                        <h3 class="post-title">${post.title}</h3>
                        <p class="post-content">${post.content}</p>
                        <div class="hashtags">
                            ${post.hashtags.map(hashtag => {
                                return `<p class="hashtag">${hashtag}</p>`;
                            }).join('')} 
                        </div>
                    </div>
                `;
            });

            this.elements.postsHolder.innerHTML = html;

            
        },


        renderData(){
            this.elements.postsGeneratedEls.forEach(el=>{
               el.innerHTML = this.state.posts.length;
            });

            this.elements.eventDateEls.forEach(el=>{
               el.innerHTML = this.state.eventData.eventDate;
            });

            this.elements.daysUntilEventEls.forEach(el=>{
               el.innerHTML = this.getDaysUntil(this.state.eventData.eventDate);
            });
        },

        getDaysUntil(futureDateStr) {
         // Get today's date and set the time to the beginning of the day
         const today = new Date();
         today.setHours(0, 0, 0, 0);
       
         // Create a Date object for the future date
         const futureDate = new Date(futureDateStr);
       
         // Calculate the difference in milliseconds
         const timeDifference = futureDate.getTime() - today.getTime();
       
         // Convert milliseconds to days and round up
         const daysRemaining = Math.ceil(timeDifference / (1000 * 60 * 60 * 24));
       
         return daysRemaining;
        },

    };

    document.addEventListener('DOMContentLoaded', () => {
        EventSocialManager.init();
    });
</script>



